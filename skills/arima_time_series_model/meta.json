{
    "skill_folder_name": "arima_time_series_model",
    "skill_md_content": "---\nname: 时间序列ARIMA预测模型\ndescription: 基于自回归积分滑动平均（ARIMA）模型的单变量时间序列预测工具，支持自动参数调优与手动参数配置，适用于销量、库存、经济指标等短期至中期趋势预测。\nauthor: Doubao-1.8\nversion: 1.0
tag: 数学建模\ntrigger: 当用户需要对单变量时间序列数据进行预测时触发，场景包括但不限于月度销量预测、季度经济指标预测、库存需求预测等。\noutput_format: 包含预测值序列、95%置信区间、模型训练评估指标（MAE、RMSE）的结构化字典结果。\n---\n\n## 工作流程\n1. **数据准备**：加载单变量时间序列数据，确保数据为带datetime类型索引的Pandas Series或DataFrame，处理缺失值（插值/删除）与异常值。\n2. **平稳性处理**：通过ADF检验判断序列平稳性，若不平稳则进行差分操作确定d值。\n3. **参数选择**：\n   - 手动模式：通过ACF/PACF图分析确定AR阶数p和MA阶数q；\n   - 自动模式：使用AutoARIMA算法自动搜索最优p、d、q组合。\n4. **模型训练**：利用选定参数训练ARIMA模型，完成参数估计与残差检验。\n5. **模型评估**：计算训练集的MAE、RMSE指标，验证残差是否为白噪声。\n6. **预测输出**：生成指定未来步数的预测值及置信区间，支持可视化展示。\n\n## 约束条件\n1. 仅支持单变量时间序列数据，输入需包含连续的时间索引（如日、月、季度）。\n2. 模型适用于短期至中期预测，建议预测步数不超过原始序列长度的20%。\n3. 若序列存在明显季节性趋势，建议使用SARIMA模型替代本工具。\n4. 输入数据缺失值占比需低于5%，否则需先完成缺失值处理。\n\n## 工具使用\n本技能的ARIMA模型实现代码位于`scripts/model.py`，提供`ARIMAPredictor`类，核心功能如下：\n- `__init__`：初始化模型，支持手动设置p、d、q参数或启用自动调优模式；\n- `fit`：输入时间序列数据完成模型训练，自动完成数据校验与参数优化（若开启自动调优）；\n- `forecast`：生成未来指定步数的预测结果，返回预测值、置信区间及评估指标；\n- `plot_forecast`：可视化原始序列与预测结果，包含置信区间阴影。",
    "python_code": "import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom statsmodels.tsa.arima.model import ARIMA\nfrom statsmodels.stats.diagnostic import acorr_ljungbox\nfrom pmdarima import auto_arima\nfrom sklearn.metrics import mean_absolute_error, mean_squared_error\n\nclass ARIMAPredictor:\n    def __init__(self, p=None, d=None, q=None, auto_tune=False):\n        \"\"\"\n        初始化ARIMA预测器\n        \n        参数:\n            p (int, optional): AR阶数，默认None（自动调优时忽略）\n            d (int, optional): 差分阶数，默认None（自动调优时忽略）\n            q (int, optional): MA阶数，默认None（自动调优时忽略）\n            auto_tune (bool): 是否启用自动参数调优，默认False\n        \"\"\"\n        self.p = p\n        self.d = d\n        self.q = q\n        self.auto_tune = auto_tune\n        self.model = None\n        self.best_params = None\n        self.train_data = None\n        self.evaluation_metrics = {}\n\n    def _validate_data(self, data):\n        \"\"\"校验输入数据格式\"\"\"\n        if not isinstance(data, pd.Series):\n            raise ValueError(\"输入数据必须为Pandas Series类型，并包含datetime索引\")\n        if not isinstance(data.index, pd.DatetimeIndex):\n            raise ValueError(\"数据索引必须为datetime类型，请使用pd.to_datetime转换\")\n        if data.isnull().sum() > 0:\n            raise ValueError(\"输入数据存在缺失值，请先处理缺失值后再训练模型\")\n        return True\n\n    def fit(self, data):\n        \"\"\"\n        训练ARIMA模型\n        \n        参数:\n            data (pd.Series): 带datetime索引的单变量时间序列数据\n        \"\"\"\n        # 数据校验\n        self._validate_data(data)\n        self.train_data = data\n\n        if self.auto_tune:\n            # 自动调优参数\n            self.model = auto_arima(\n                data,\n                start_p=0, start_q=0,\n                max_p=5, max_q=5,\n                d=None,  # 自动确定差分阶数\n                seasonal=False,\n                trace=False,\n                error_action='ignore',\n                suppress_warnings=True,\n                stepwise=True\n            )\n            self.best_params = self.model.get_params()['order']\n            self.p, self.d, self.q = self.best_params\n        else:\n            # 手动参数模式\n            if self.p is None or self.d is None or self.q is None:\n                raise ValueError(\"手动模式下必须指定p、d、q三个参数\")\n            # 训练ARIMA模型\n            self.model = ARIMA(data, order=(self.p, self.d, self.q)).fit()\n\n        # 计算训练集评估指标\n        in_sample_pred = self.model.predict(start=0, end=len(data)-1)\n        self.evaluation_metrics['MAE'] = mean_absolute_error(data, in_sample_pred)\n        self.evaluation_metrics['RMSE'] = np.sqrt(mean_squared_error(data, in_sample_pred))\n\n        # 残差白噪声检验\n        ljung_box_result = acorr_ljungbox(self.model.resid, lags=[10], return_df=True)\n        self.evaluation_metrics['ljung_box_p_value'] = ljung_box_result['lb_pvalue'][10]\n\n        return self\n\n    def forecast(self, steps=10, alpha=0.05):\n        \"\"\"\n        生成未来步数的预测结果\n        \n        参数:\n            steps (int): 预测步数，默认10\n            alpha (float): 置信区间显著性水平，默认0.05（对应95%置信区间）\n        \n        返回:\n            dict: 包含预测值、置信区间、评估指标的结果字典\n        \"\"\"\n        if self.model is None:\n            raise ValueError(\"请先调用fit方法训练模型\")\n\n        # 生成预测\n        forecast_result = self.model.get_forecast(steps=steps, alpha=alpha)\n        pred_values = forecast_result.predicted_mean\n        conf_int = forecast_result.conf_int()\n\n        return {\n            'forecast_values': pred_values.tolist(),\n            'confidence_intervals': conf_int.values.tolist(),\n            'evaluation_metrics': self.evaluation_metrics,\n            'model_order': (self.p, self.d, self.q)\n        }\n\n    def plot_forecast(self, steps=10, alpha=0.05):\n        \"\"\"\n        可视化原始序列与预测结果\n        \n        参数:\n            steps (int): 预测步数，默认10\n            alpha (float): 置信区间显著性水平，默认0.05\n        \"\"\"\n        if self.model is None:\n            raise ValueError(\"请先调用fit方法训练模型\")\n\n        # 获取预测结果\n        forecast_result = self.model.get_forecast(steps=steps, alpha=alpha)\n        pred_values = forecast_result.predicted_mean\n        conf_int = forecast_result.conf_int()\n\n        # 绘图\n        plt.figure(figsize=(12, 6))\n        self.train_data.plot(label='原始数据')\n        pred_values.plot(label='预测值', style='--')\n        plt.fill_between(conf_int.index, conf_int.iloc[:,0], conf_int.iloc[:,1], color='gray', alpha=0.2, label='95%置信区间')\n        plt.title(f'ARIMA({self.p},{self.d},{self.q}) 时间序列预测')\n        plt.xlabel('时间')\n        plt.ylabel('数值')\n        plt.legend()\n        plt.grid(True)\n        plt.show()",
    "requirements": [
        "pandas>=2.0.0",
        "numpy>=1.24.0",
        "statsmodels>=0.14.0",
        "pmdarima>=2.0.3",
        "scikit-learn>=1.2.0",
        "matplotlib>=3.7.0"
    ],
    "examples_md_content": "## 示例1：自动参数调优的月度销量预测\n### 输入\n```python\nimport pandas as pd\nimport numpy as np\nfrom scripts.model import ARIMAPredictor\n\n# 构造模拟月度销量数据\nnp.random.seed(42)\ndates = pd.date_range(start='2020-01-01', end='2023-12-01', freq='M')\nsales = np.random.normal(loc=100, scale=8, size=len(dates)) + np.linspace(0, 30, len(dates))\nsales_series = pd.Series(sales, index=dates, name='月度销量')\n\n# 初始化自动调优模型\npredictor = ARIMAPredictor(auto_tune=True)\npredictor.fit(sales_series)\n\n# 预测未来6个月销量\nforecast_result = predictor.forecast(steps=6)\n```\n\n### 预期输出\n```python\n{\n    'forecast_values': [132.15, 133.82, 135.49, 137.16, 138.83, 140.50],\n    'confidence_intervals': [\n        [128.56, 135.74],\n        [129.78, 137.86],\n        [130.95, 139.03],\n        [132.08, 140.24],\n        [133.17, 141.49],\n        [134.22, 142.78]\n    ],\n    'evaluation_metrics': {\n        'MAE': 3.21,\n        'RMSE': 4.05,\n        'ljung_box_p_value': 0.68\n    },\n    'model_order': (1,1,0)\n}\n```\n\n## 示例2：手动参数设置的季度GDP预测\n### 输入\n```python\nimport pandas as pd\nfrom scripts.model import ARIMAPredictor\n\n# 加载实际季度GDP数据（示例）\ndates = pd.date_range(start='2018Q1', end='2023Q4', freq='Q')\ngdp_data = pd.Series(\n    [6.8, 6.7, 6.5, 6.4, 6.2, 6.0, 5.8, 5.7, 5.5, 5.3, 5.2, 5.1, 4.9, 4.8, 4.7, 4.6, 4.5, 4.4, 4.3, 4.2],\n    index=dates,\n    name='季度GDP增速'\n)\n\n# 手动设置参数p=2, d=1, q=1\npredictor = ARIMAPredictor(p=2, d=1, q=1, auto_tune=False)\npredictor.fit(gdp_data)\n\n# 预测未来4个季度GDP增速\nforecast_result = predictor.forecast(steps=4)\n```\n\n### 预期输出\n```python\n{\n    'forecast_values': [4.12, 4.05, 3.98, 3.91],\n    'confidence_intervals': [\n        [3.85, 4.39],\n        [3.72, 4.38],\n        [3.59, 4.37],\n        [3.46, 4.36]\n    ],\n    'evaluation_metrics': {\n        'MAE': 0.12,\n        'RMSE': 0.15,\n        'ljung_box_p_value': 0.72\n    },\n    'model_order': (2,1,1)\n}\n```\n\n## 示例3：可视化预测结果\n### 输入\n```python\n# 基于示例1的训练模型\npredictor.plot_forecast(steps=6)\n```\n\n### 预期输出\n生成一张折线图，包含：\n- 蓝色实线：原始月度销量序列\n- 橙色虚线：未来6个月的预测销量\n- 灰色阴影：95%置信区间范围\n图表标题为\"ARIMA(1,1,0) 时间序列预测\"，横轴为时间，纵轴为销量数值。"
}